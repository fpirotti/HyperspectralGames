<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Francesco Pirotti - CIRGEO / TESAF - Università di Padova" />


<title>Analizzare Immagini Digitali: dalla Visualizzazione all’Intelligenza Artificiale</title>

<style>
.load1 .loader,
.load1 .loader:before,
.load1 .loader:after {
  background: #ffffff;
  -webkit-animation: load1 1s infinite ease-in-out;
  animation: load1 1s infinite ease-in-out;
  width: 1em;
  height: 4em;
}
.load1 .loader {
  color: #ffffff;
  text-indent: -9999em;
  margin: 8px auto;
  position: relative;
  font-size: 11px;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-animation-delay: -0.16s;
  animation-delay: -0.16s;
}
.load1 .loader:before,
.load1 .loader:after {
  position: absolute;
  top: 0;
  content: '';
}
.load1 .loader:before {
  left: -1.5em;
  -webkit-animation-delay: -0.32s;
  animation-delay: -0.32s;
}
.load1 .loader:after {
  left: 1.5em;
}
@-webkit-keyframes load1 {
  0%,
  80%,
  100% {
    box-shadow: 0 0;
    height: 4em;
  }
  40% {
    box-shadow: 0 -2em;
    height: 5em;
  }
}
@keyframes load1 {
  0%,
  80%,
  100% {
    box-shadow: 0 0;
    height: 4em;
  }
  40% {
    box-shadow: 0 -2em;
    height: 5em;
  }
}
.shiny-spinner-output-container {
  position: relative;
}

.load-container {
  position: absolute;
  top: 20%;
  -webkit-transform: translateY(-50%);
  transform: translateY(-50%);
  /* to avoid showing a vertical scrollbar
  http://stackoverflow.com/questions/38251204/horizontal-animation-causes-vertical-scrollbar-in-css */
  overflow:hidden; 
  width: 100%;
}

.shiny-spinner-hidden {
  position: absolute;
  top:0;
  left:0;
  z-index: -1;
  visibility:hidden;
}
.load1 .loader, .load1 .loader:before, .load1 .loader:after {background: #333} .load1 .loader {color: #333}
.load1 .loader {font-size: 8px}
</style>
<script>
(function() {
var output_states = [];

function show_spinner(id) {
    $("#"+id).siblings(".load-container, .shiny-spinner-placeholder").removeClass('shiny-spinner-hidden');
//    $("#"+id).siblings(".load-container").siblings('.shiny-bound-output, .shiny-output-error').css('visibility', 'hidden');
    // if there is a proxy div, hide the previous output
//    $("#"+id).siblings(".shiny-spinner-placeholder").siblings('.shiny-bound-output, .shiny-output-error').addClass('shiny-spinner-hidden');
}

function hide_spinner(id) {
    $("#"+id).siblings(".load-container, .shiny-spinner-placeholder").addClass('shiny-spinner-hidden');
    $("#"+id).siblings(".load-container").siblings('.shiny-bound-output').css('visibility', 'visible');
    // if there is a proxy div, show the previous output in case it was hidden
    $("#"+id).siblings(".shiny-spinner-placeholder").siblings('.shiny-bound-output').removeClass('shiny-spinner-hidden');
}

function update_spinner(id) {
  if (!(id in output_states)) {
    show_spinner(id);
  }
  if (output_states[id] <= 0) {
    show_spinner(id);
  } else {
    hide_spinner(id);
  }
}

$(document).on('shiny:bound', function(event){ 
  /* if not bound before, then set the value to 0 */
  if (!(event.target.id in output_states)) {
    output_states[event.target.id] = 0;
  }
  update_spinner(event.target.id);
});

/* When recalculating starts, show the spinner container & hide the output */
$(document).on('shiny:outputinvalidated', function(event) {
  output_states[event.target.id] = 0;
  update_spinner(event.target.id);
});

/* When new value or error comes in, hide spinner container (if any) & show the output */
$(document).on('shiny:value shiny:error', function(event) {
  output_states[event.target.id] = 1;
  update_spinner(event.target.id);
});
}()); 


function requestFullScreen(element) {
    // Supports most browsers and their versions.
    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

    if (requestMethod) { // Native full screen.
        requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
        var wscript = new ActiveXObject("WScript.Shell");
        if (wscript !== null) {
            wscript.SendKeys("{F11}");
        }
    }
}


function checkCookie(cname, text) {
  var username = getCookie(cname);
  if (username != "") {    
    username = prompt(text, username);
    if (username != "" && username != null) {
      setCookie(cname, username, 365);
    }
  } else {
    username = prompt(text, "");
    if (username != "" && username != null) {
      setCookie(cname, username, 365);
    }
  }
  
  Shiny.setInputValue("cookie.username", username, {priority: "event"});
}

function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function setCookie(cname, cvalue, exdays) {
  var d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  var expires = "expires="+ d.toUTCString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}


function draw(x, y, ids, colors) {
  
  $(".myCanvasTrain").remove();
  for(var i=0; i<x.length; ++i){
       var myCanvas = $('<div/>',{'class':'myCanvasTrain', 'title': 'id='+ids[i], 'style':'left:'+x[i]+'px;top:'+y[i]+'px;', id: 'myCanvas'+ids[i]   } );
$('#myImageDOMplot').parent().append(myCanvas);
    } 
}

</script>




<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="section-header">



<h1 class="title toc-ignore">Analizzare Immagini Digitali: dalla Visualizzazione all’Intelligenza Artificiale</h1>
<h4 class="author">Francesco Pirotti - CIRGEO / TESAF - Università di Padova</h4>
<h4 class="date">27/8/2020</h4>

</div>

<div id="section-TOC">
<ul>
<li><a href="#section-note-introduttive">Note introduttive</a></li>
<li><a href="#section-analisi-dellimmagine">ANALISI DELL’IMMAGINE</a></li>
<li><a href="#section-classificazione-supervisionata">Classificazione “supervisionata”</a></li>
</ul>
</div>

<style type="text/css">
.irs-bar-edge, .irs-bar {
  display:none;
}
  
#coordinate {
    height: 36px;
    margin: 0;
    margin-top: 24px;
    padding: 4px;
}

#finestraGV {
  -webkit-box-shadow: 0px 0px 13px 2px rgba(0,0,0,0.75);
  -moz-box-shadow: 0px 0px 13px 2px rgba(0,0,0,0.75);
  box-shadow: 0px 0px 13px 2px rgba(0,0,0,0.75);  
  display:block; 
  z-index:99999; 
  position:absolute;   
  width:100px; height:100px; 
  border:2px solid yellow;
  pointer-events: none;
  visibility:hidden;
}

* {box-sizing: border-box;}

.shiny-notification {
              height: 200px;
              width: 600px;
              position:fixed;
              top: calc(50% - 50px);
              left: calc(50% - 400px);
              opacity: 0.95;
              font-weight:bold;
            }
.img-zoom-container {
  position: relative;
}

.img-zoom-lens {
  pointer-events: none;
  position: absolute;
  border: 2px solid red; 
  z-index:99999; 
}

.myCanvasTrain{
  width:5px;
  height:5px;
  border:solid 2px red;
  z-index:999;
  position:absolute;
  pointer-events: none;
  -webkit-box-shadow: 0px 0px 0px 2px rgba(255,255,255,0.95);
  -moz-box-shadow: 0px 0px 0px 2px rgba(255,255,255,0.95);
  box-shadow: 0px 0px 0px 2px rgba(255,255,255,0.95);  
}

div.main-container{
  max-width:9000px !important;  
}
#myImageDOMplot {
 position: relative;
}
.img-zoom-result {
  position:absolute;
  background-repeat:space;
  border: 2px solid rgb(255, 0 ,0); 
  width: 160px;
  height: 160px;
  z-index:99999; 
  visibility:hidden;
}

.img-zoom-result-inner {   
  border: 2px solid rgb(255, 0 ,0); 
  width: 10px;
  height: 10px;
  margin:75px auto;
  z-index:99999;
}

.highlightStyle {
  background:#ffff0038;
  position:absolute;
  margin:-10px; 
  border:3px solid #ff3300; 
  z-index:99999999999;
}
</style>
<script type="text/javascript">
 var initialized = false;
 var  lens, lens2, result, cx, cy, lenszoom,  myCanvas, img;
 lenszoom=0;
  
 

  
$( document ).ready(function() {
 checkCookie("email","Inserisci email, verrà utilizzata unicamente per memorizzare le tue impostazioni.");
 $("#pannelli").children().css({ 'font-weight':'bold', 'font-size':'16px' })
});

  
  
 $('#myImageDOMplot').on('DOMSubtreeModified', 'img', function(){
  imageZoom( this, "myresult", true );
  });

  
  function highlightWidget(wg, time=10000){ 
  
      tt = document.createElement("DIV");
      tt.setAttribute("class", "highlightStyle");  
      tt.style.width= (wg[0].offsetWidth+20)+"px";
      tt.style.height= (wg[0].offsetHeight+20)+"px"; 
      wg.before(tt);
 
      $(tt).on("mouseenter", function(){ $(tt).fadeOut(1000)  } ); 
   // wg.addClass("highlightStyle");
      setTimeout(function(){ $(tt).fadeOut(2000) }, time); 
      setTimeout(function(){  $(tt).remove() }, time+2000); 
  }
  
    function enterImg(e) { result.style.visibility="visible";  lens.style.visibility="visible";  }
    function exitImg(e) { result.style.visibility="hidden";    lens.style.visibility="hidden"; }

    function moveLens(e) {
      var pos, x, y;
      /*prevent any other actions that may occur when moving over the image:*/
      e.preventDefault();
      /*get the cursor's x and y positions:*/
      pos = getCursorPos(e);
      /*calculate the position of the lens:*/

      putLens(pos.x,pos.y);
 

    }
    
    function putLens(x1,y1){
    
      var x = x1 - (lens.offsetWidth / 2);
      var y = y1 - (lens.offsetHeight / 2);
      
      lens.style.left = x + "px";
      lens.style.top = y + "px";
      
      result.style.left = (x + lens.offsetWidth) + "px";
      result.style.top = y + "px";
       
      result.style.backgroundPosition =   (-1*x * cx) + "px " + (-1*y * cy) + "px";
    }
    function getCursorPos(e) {
      var a, x = 0, y = 0;
      e = e || window.event;
      /*get the x and y positions of the image:*/
      a = img.getBoundingClientRect();
      /*calculate the cursor's x and y coordinates, relative to the image:*/
      x = e.pageX - a.left;
      y = e.pageY - a.top;
      /*consider any page scrolling:*/
      x = x - window.pageXOffset;
      y = y - window.pageYOffset;
      return {x : x, y : y};
    }
      

 function imageZoom(img2, resultID, domreload=false) {
  
    // img = document.getElementById(imgID).children[0];
    result = document.getElementById(resultID); 
    /*create lens:*/
    if( $(".img-zoom-lens").length == 0) {
      lens = document.createElement("DIV");
      lens.setAttribute("class", "img-zoom-lens"); 
     
      lens.style.height= (result.offsetWidth / lenszoom)+"px";
      lens.style.width= (result.offsetHeight / lenszoom)+"px";
      img2.parentElement.parentElement.insertBefore(lens, img2.parentElement);
    } else {
      lens.style.height= (result.offsetWidth / lenszoom)+"px";
      lens.style.width= (result.offsetHeight / lenszoom)+"px"; 
    }
         /*calculate the ratio between result DIV and lens:*/
    cx = result.offsetWidth / lens.offsetWidth;
    cy = result.offsetHeight / lens.offsetHeight;
      /*execute a function when someone moves the cursor over the image, or the lens:*/
   // lens.addEventListener("mousemove", moveLens);
     img2.removeEventListener("mousemove",moveLens);
     img2.removeEventListener("mouseenter",enterImg);
     img2.removeEventListener("mouseout",exitImg);
     img2.removeEventListener("touchmove",moveLens);
     if(lenszoom!=0){
        img2.addEventListener("mousemove", moveLens); 
        img2.addEventListener("mouseenter", enterImg); 
        img2.addEventListener("touchmove", moveLens);
     }
    img2.addEventListener("mouseout", exitImg);  
 
    
    /*set background properties for the result DIV:*/
   if(domreload) $(result).css({ 'background-color':'white', 'background-image' : 'url(' + img2.src + ')'  });
    //result.style.backgroundImage = "url('" + img.src + "')";
//    result.style.background = "white";
    result.style.backgroundSize = (img2.width * cx) + "px " + (img2.height * cy) + "px";
    
    img=img2;
    
  
}
 
 
 
 
</script>
<!--SHINY.SINGLETON[b2b14e02c71d6015a0a99c074a690d98166a4d6d]-->
<script>Shiny.addCustomMessageHandler('shinyjs-show', function(params) { shinyjs.debugMessage('shinyjs: calling function "show" with parameters:'); shinyjs.debugMessage(params); shinyjs.show(params);});
Shiny.addCustomMessageHandler('shinyjs-hide', function(params) { shinyjs.debugMessage('shinyjs: calling function "hide" with parameters:'); shinyjs.debugMessage(params); shinyjs.hide(params);});
Shiny.addCustomMessageHandler('shinyjs-toggle', function(params) { shinyjs.debugMessage('shinyjs: calling function "toggle" with parameters:'); shinyjs.debugMessage(params); shinyjs.toggle(params);});
Shiny.addCustomMessageHandler('shinyjs-enable', function(params) { shinyjs.debugMessage('shinyjs: calling function "enable" with parameters:'); shinyjs.debugMessage(params); shinyjs.enable(params);});
Shiny.addCustomMessageHandler('shinyjs-disable', function(params) { shinyjs.debugMessage('shinyjs: calling function "disable" with parameters:'); shinyjs.debugMessage(params); shinyjs.disable(params);});
Shiny.addCustomMessageHandler('shinyjs-toggleState', function(params) { shinyjs.debugMessage('shinyjs: calling function "toggleState" with parameters:'); shinyjs.debugMessage(params); shinyjs.toggleState(params);});
Shiny.addCustomMessageHandler('shinyjs-addClass', function(params) { shinyjs.debugMessage('shinyjs: calling function "addClass" with parameters:'); shinyjs.debugMessage(params); shinyjs.addClass(params);});
Shiny.addCustomMessageHandler('shinyjs-removeClass', function(params) { shinyjs.debugMessage('shinyjs: calling function "removeClass" with parameters:'); shinyjs.debugMessage(params); shinyjs.removeClass(params);});
Shiny.addCustomMessageHandler('shinyjs-toggleClass', function(params) { shinyjs.debugMessage('shinyjs: calling function "toggleClass" with parameters:'); shinyjs.debugMessage(params); shinyjs.toggleClass(params);});
Shiny.addCustomMessageHandler('shinyjs-html', function(params) { shinyjs.debugMessage('shinyjs: calling function "html" with parameters:'); shinyjs.debugMessage(params); shinyjs.html(params);});
Shiny.addCustomMessageHandler('shinyjs-onevent', function(params) { shinyjs.debugMessage('shinyjs: calling function "onevent" with parameters:'); shinyjs.debugMessage(params); shinyjs.onevent(params);});
Shiny.addCustomMessageHandler('shinyjs-alert', function(params) { shinyjs.debugMessage('shinyjs: calling function "alert" with parameters:'); shinyjs.debugMessage(params); shinyjs.alert(params);});
Shiny.addCustomMessageHandler('shinyjs-logjs', function(params) { shinyjs.debugMessage('shinyjs: calling function "logjs" with parameters:'); shinyjs.debugMessage(params); shinyjs.logjs(params);});
Shiny.addCustomMessageHandler('shinyjs-runjs', function(params) { shinyjs.debugMessage('shinyjs: calling function "runjs" with parameters:'); shinyjs.debugMessage(params); shinyjs.runjs(params);});
Shiny.addCustomMessageHandler('shinyjs-reset', function(params) { shinyjs.debugMessage('shinyjs: calling function "reset" with parameters:'); shinyjs.debugMessage(params); shinyjs.reset(params);});
Shiny.addCustomMessageHandler('shinyjs-delay', function(params) { shinyjs.debugMessage('shinyjs: calling function "delay" with parameters:'); shinyjs.debugMessage(params); shinyjs.delay(params);});
Shiny.addCustomMessageHandler('shinyjs-click', function(params) { shinyjs.debugMessage('shinyjs: calling function "click" with parameters:'); shinyjs.debugMessage(params); shinyjs.click(params);});</script>
<script src="shinyjs/shinyjs-default-funcs.js"></script>
<script>shinyjs.debug = false;</script>
<style>.shinyjs-hide { display: none !important; }</style>
<!--/SHINY.SINGLETON[b2b14e02c71d6015a0a99c074a690d98166a4d6d]-->
<p><B style=" color:red;" >SI CONSIGLIA DI VISUALIZZARE LA PAGINA A PIENO SCHERMO (tasto F11)</B></p>
<div id="section-note-introduttive" class="section level2">
<h2>Note introduttive</h2>
<p><strong>Il codice in R di questo esercizio è disponibile in GitHub <a href="https://github.com/fpirotti/HyperspectralGames" target="_blank">QUI</a></strong></p>
<p>Nelle sezioni seguenti vedrete un ritaglio di un’immagine Sentinel-2 ripresa sopra la città di Padova il giorno 24 aprile 2018 (noterete facilmente in alto a destra Prato della Valle). Sono caricate le <a href="https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2_SR#bands" target="_blank">bande corrette atmosfericamente a BOA (Bottom of Atmosphere)</a>.</p>
<p>Il pannello a sinistra contiene l’immagine consentendo:</p>
<ul>
<li>assegnare combinazioni di <a href="https://it.wikipedia.org/wiki/Spettro_elettromagnetico#Suddivisione_in_bande" target="_blank"><strong>bande</strong></a> dello <a href="https://it.wikipedia.org/wiki/Spettro_elettromagnetico" target="_blank"><strong>spettro elettromagnetico</strong></a> ai tre canali dello schermo.</li>
<li>ingrandire a vari livelli una zona per identificare meglio gli elementi</li>
<li>cliccando un punto verranno analizzati alcuni aspetti nel pannello a destra.</li>
</ul>
<p>Il pannello a destra dell’immagine contiene sezioni che consentono:</p>
<ul>
<li><strong>Valori di Grigio</strong>: ingrandire una finestra per vedere i singoli valori dei pixel per ogni banda.</li>
<li><strong>Firme Spettrali</strong>: calcolare la <a href="https://it.wikipedia.org/wiki/Firma_spettrale" target="_blank"><strong>firma spettrale</strong></a> su un punto selezionato nell’immagine</li>
<li><strong>Indici</strong>: l’applicazione di operazioni tra bande per creare degli <strong>indicatori</strong> (e.g. <a href="https://it.wikipedia.org/wiki/Normalized_Difference_Vegetation_Index" target="_blank">NDVI</a>) che aiutano l’interpretazione di alcuni fenomeni.</li>
<li><strong>Training POI</strong>: la definizione di punti sull’immagine per l’addestramento del modello (punti definiti anche <strong>ROI/POI</strong> - regions/points of interest, regioni/punti di interesse)</li>
</ul>
<p>La sezione successiva consente operazioni per la <strong>classificazione supervisionata</strong> (i.e. con il supporto dei punti POI definiti dall’operatore al punto precedente):</p>
<ul>
<li>La creazione di <strong>modelli predittivi</strong> usanto i dati di addestramento/training con:
<ul>
<li>metodi classici ( <strong>Maximum Likelyhood</strong>, <strong>Spectral Angle Mapper</strong>, <strong>Minimum Distance</strong>)</li>
<li>metodi di A.I. - <strong>machine learning</strong> (Random Forest, Support Vector Machine)</li>
<li>metodi di A.I. - <strong>deep learning</strong> (reti neurali multi-strato…)</li>
</ul></li>
<li>Le operazioni di <strong>analisi dell’accuratezza stimata</strong> mediante <a href="https://it.wikipedia.org/wiki/Matrice_di_confusione" target="_blank">matrici di confusione</a> e la creazione di <strong>indici di accuratezza</strong> per classe e totali (indice <a href="https://it.wikipedia.org/wiki/Kappa_di_Cohen" target="_blank"><strong>Kappa</strong></a>, <a href="https://it.wikipedia.org/wiki/Receiver_operating_characteristic" target="_blank"><strong>ROC</strong></a>, <a href="https://it.wikipedia.org/wiki/Precisione_e_recupero" target="_blank"><strong>precisione/recupero</strong></a>, <a href="https://it.wikipedia.org/wiki/Falso_positivo" target="_blank"><strong>falsi positivi</strong></a>, <a href="https://it.wikipedia.org/wiki/Falso_negativo" target="_blank"><strong>falsi negativi</strong></a>, <a href="https://it.wikipedia.org/wiki/F1_score" target="_blank"><strong>F1-score</strong></a>, etc…)</li>
</ul>
<p>Vengono proposti esercizi nelle varie sezioni che potete eseguire con l’interfaccia.</p>
</div>
<div id="section-analisi-dellimmagine" class="section level2">
<h2>ANALISI DELL’IMMAGINE</h2>
<div class="row">
<div class="col-sm-6" style="margin:0; margin-bottom:10px; margin-left:5px; padding:0; width:620px !important;">
<div style="margin:0; display:flex; gap: 5px;   width:680px !important;">
<div class="form-group shiny-input-container" style="width: 240px;">
<label class="control-label" for="colorChoose">Precaricati</label>
<select data-width="240" id="colorChoose" class="selectpicker form-control"><option value="B4, B3, B2">Colori Naturali (B4, B3, B2)</option>
<option value="B8, B4, B3">Colori NIR (B8, B4, B3)</option>
<option value="B12, B8A, B4">SW IR (B12, B8A, B4)</option>
<option value="B12, B11, B2">Geologia (B12, B11, B2)</option>
<option value="B4, B3, B1">Batimetria (B4, B3, B1)</option>
<option value="B11, B8, B2">Agricoltura (B11, B8, B2)</option></select>
</div>
<div class="form-group shiny-input-container shiny-input-radiogroup shiny-input-container-inline" style="width: 220px">
<label class="control-label" for="zoomLens">Ingrandimento Lente</label>
<br/>
<div id="zoomLens" class="radioGroupButtons" style="width: 100%;">
<div aria-label="..." class="btn-group btn-group-justified btn-group-container-sw" data-toggle="buttons" role="group">
<div class="btn-group btn-group-toggle" role="group">
<button class="btn radiobtn btn-default">
<input type="radio" autocomplete="off" name="zoomLens" value="0"/>
<i class='fa fa-ban'></i>
</button>
</div>
<div class="btn-group btn-group-toggle" role="group">
<button class="btn radiobtn btn-default">
<input type="radio" autocomplete="off" name="zoomLens" value="2"/>
<i class='fa fa-search'></i> x2
</button>
</div>
<div class="btn-group btn-group-toggle" role="group">
<button class="btn radiobtn btn-default active">
<input type="radio" autocomplete="off" name="zoomLens" value="4" checked="checked"/>
<i class='fa fa-search'></i> x4
</button>
</div>
<div class="btn-group btn-group-toggle" role="group">
<button class="btn radiobtn btn-default">
<input type="radio" autocomplete="off" name="zoomLens" value="8"/>
<i class='fa fa-search'></i> x8
</button>
</div>
</div>
</div>
</div>
<pre id="coordinate" class="shiny-text-output noplaceholder"></pre>
</div>
<div style="margin:0; display:flex; gap: 5px; ">
<div class="form-group shiny-input-container" style="width: 180px;">
<label class="control-label" for="bandR">Rosso</label>
<select data-width="180" id="bandR" class="selectpicker form-control"><optgroup label="Visibile">
<option value="B1">B1-442nm (60m)</option>
<option value="B2">B2-490nm (10m)</option>
<option value="B3">B3-560nm (10m)</option>
<option value="B4" selected>B4-665nm (10m)</option>
</optgroup>
<optgroup label="NIR/Red Edge">
<option value="B5">B5-705nm (20m)</option>
<option value="B6">B6-740nm (20m)</option>
<option value="B7">B7-783nm (20m)</option>
<option value="B8">B8-842nm (10m)</option>
<option value="B8A">B8A-864nm (20m)</option>
</optgroup>
<optgroup label="Cirrus">
<option value="B9">B9-945nm (60m)</option>
</optgroup>
<optgroup label="SWIR">
<option value="B11">B11-1610nm (20m)</option>
<option value="B12">B12-2190nm (20m)</option>
</optgroup></select>
</div>
<div class="form-group shiny-input-container" style="width: 180px;">
<label class="control-label" for="bandG">Verde</label>
<select data-width="180" id="bandG" class="selectpicker form-control"><optgroup label="Visibile">
<option value="B1">B1-442nm (60m)</option>
<option value="B2">B2-490nm (10m)</option>
<option value="B3" selected>B3-560nm (10m)</option>
<option value="B4">B4-665nm (10m)</option>
</optgroup>
<optgroup label="NIR/Red Edge">
<option value="B5">B5-705nm (20m)</option>
<option value="B6">B6-740nm (20m)</option>
<option value="B7">B7-783nm (20m)</option>
<option value="B8">B8-842nm (10m)</option>
<option value="B8A">B8A-864nm (20m)</option>
</optgroup>
<optgroup label="Cirrus">
<option value="B9">B9-945nm (60m)</option>
</optgroup>
<optgroup label="SWIR">
<option value="B11">B11-1610nm (20m)</option>
<option value="B12">B12-2190nm (20m)</option>
</optgroup></select>
</div>
<div class="form-group shiny-input-container" style="width: 180px;">
<label class="control-label" for="bandB">Blue</label>
<select data-width="180" id="bandB" class="selectpicker form-control"><optgroup label="Visibile">
<option value="B1">B1-442nm (60m)</option>
<option value="B2" selected>B2-490nm (10m)</option>
<option value="B3">B3-560nm (10m)</option>
<option value="B4">B4-665nm (10m)</option>
</optgroup>
<optgroup label="NIR/Red Edge">
<option value="B5">B5-705nm (20m)</option>
<option value="B6">B6-740nm (20m)</option>
<option value="B7">B7-783nm (20m)</option>
<option value="B8">B8-842nm (10m)</option>
<option value="B8A">B8A-864nm (20m)</option>
</optgroup>
<optgroup label="Cirrus">
<option value="B9">B9-945nm (60m)</option>
</optgroup>
<optgroup label="SWIR">
<option value="B11">B11-1610nm (20m)</option>
<option value="B12">B12-2190nm (20m)</option>
</optgroup></select>
</div>
</div>
<div style="position:relative;">
<div id="myresult" class="img-zoom-result">
<div class="img-zoom-result-inner"></div>
</div>
<div id="finestraGV"></div>
<!--SHINY.SINGLETON[3891ac171834ed25f436995ba40a47edd74e5169]-->
<!--/SHINY.SINGLETON[3891ac171834ed25f436995ba40a47edd74e5169]-->
<!--SHINY.SINGLETON[45534f2c59c7069db5da7f5118dc12c792e86de5]-->
<!--/SHINY.SINGLETON[45534f2c59c7069db5da7f5118dc12c792e86de5]-->
<div class="shiny-spinner-output-container  ">
<div class="load-container shiny-spinner-hidden load1">
<div id="spinner-1208539ca77a9e6724488115a7aebe0d" class="loader">Loading...</div>
</div>
<div id="myImageDOMplot" class="shiny-image-output" style="width: 604px ; height: 409px" data-click-id="plot_click" data-click-clip="TRUE" data-hover-id="plot_hover" data-hover-delay="300" data-hover-delay-type="debounce" data-hover-clip="TRUE" data-hover-null-outside="TRUE"></div>
</div>
</div>
</div>
<div class="col-sm-6" style="margin:0;  !important;  min-width:650px !important; width:calc(100vw - 650px); margin-bottom:10px;">
<div class="tabbable">
<ul class="nav nav-tabs shiny-tab-input" id="pannelli" data-tabsetid="1819">
<li class="active">
<a href="#tab-1819-1" data-toggle="tab" data-value="GV.panel">Valori di grigio</a>
</li>
<li>
<a href="#tab-1819-2" data-toggle="tab" data-value="firme.panel">Firme Spettrali</a>
</li>
<li>
<a href="#tab-1819-3" data-toggle="tab" data-value="indici.panel">Indici</a>
</li>
<li>
<a href="#tab-1819-4" data-toggle="tab" data-value="classificazione.panel">Training POI</a>
</li>
</ul>
<div class="tab-content" data-tabsetid="1819">
<div class="tab-pane active" data-value="GV.panel" id="tab-1819-1">
<div class="row">
<div class="col-sm-4" title="Dimensioni della finestra che verrà ritagliata intorno al punto selezionato">
<div class="form-group shiny-input-container">
<label class="control-label" for="dimGV">Dimensione finestra</label>
<input class="js-range-slider" id="dimGV" data-min="5" data-max="25" data-from="11" data-step="2" data-grid="true" data-grid-num="10" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number"/>
</div>
</div>
<div class="col-sm-8">
<div style="text-align:justify; margin-top:10px;"><b>Clicca sull'immagine a sinistra</b>  per identificare una finestra di NxN pixel (N = dimensione impostata qui dalla barra qui a sinistra). Verrà disegnato un grafico interattivo per ogni banda, con i valori di grigio (DN Digital Number) dei pixel della finestra. Spostandosi sul grafico con il puntatore, appariranno i valori di riflettanza del singolo pixel. Notare la differenza di dimensione dei pixel tra bande con diverse risoluzioni.</div>
</div>
</div>
<!--SHINY.SINGLETON[3891ac171834ed25f436995ba40a47edd74e5169]-->
<!--/SHINY.SINGLETON[3891ac171834ed25f436995ba40a47edd74e5169]-->
<!--SHINY.SINGLETON[45534f2c59c7069db5da7f5118dc12c792e86de5]-->
<!--/SHINY.SINGLETON[45534f2c59c7069db5da7f5118dc12c792e86de5]-->
<div class="shiny-spinner-output-container  ">
<div class="load-container shiny-spinner-hidden load1">
<div id="spinner-db257f3823c63d970040ecf6deb7ca78" class="loader">Loading...</div>
</div>
<div id="graphGVtiles" style="width:100%; height:1000px; " class="plotly html-widget html-widget-output shiny-report-size"></div>
</div>
</div>
<div class="tab-pane" data-value="firme.panel" id="tab-1819-2">
<div style="margin-top:10px;">
<button class="action-button bttn bttn-fill bttn-sm bttn-danger bttn-no-outline" id="resetGraph" type="button">
<i class="fa fa-trash"></i>
Cancella Firme
</button>
<b>Clicca sull'immagine a sinistra</b> per ottenere la firma spettrale. Le fasce rappresentano le bande di sensibilità del Sentinel 2 - posiziona il mouse sopra il quadrato nero in basso nel grafico per una descrizione della banda.</b>
</div>
<div id="graph1" style="width:100%; height:500px; " class="plotly html-widget html-widget-output shiny-report-size"></div>
</div>
<div class="tab-pane" data-value="indici.panel" id="tab-1819-3">
<div><b>Scegli un indice</b> dalla lista o definisci un indice; disegnalo con il pulsante verde - scarica il risultato con il pulsante.</div>
<div class="row">
<div class="col-sm-12" style="margin:0; display:flex; gap:5px; margin-top:5px;">
<div class="form-group shiny-input-container">
<label class="control-label" for="indexIn">Formula</label>
<input id="indexIn" type="text" class="form-control" value=""/>
</div>
<div class="form-group shiny-input-container" style="width: 200px;">
<label class="control-label" for="indexChoose">Precaricati</label>
<select data-width="200" id="indexChoose" class="selectpicker form-control"><option value=""></option>
<option value="B9-0.66*B11/(B9+0.6611)">Aerosol free vegetation index 1600</option>
<option value="B9-0.5*B12/(B9+0.5612)">Aerosol free vegetation index 2100</option>
<option value="-0.18+1.17*(B9-B5)/(B9+B5)">Atmospherically Resistant Vegetation Index 2</option>
<option value="(B8A-B4)/(B8A+B4)">NDVI</option></select>
</div>
<div style="  margin-top:25px;" title="Calcola e disegna">
<button class="action-button bttn bttn-fill bttn-sm bttn-success bttn-no-outline" id="indexGo" type="button">
<i class="fa fa-pencil"></i>
</button>
</div>
<div style="  margin-top:25px;" title="Scarica un geotiff">
<a id="indexDownload" class="btn btn-default shiny-download-link " href="" target="_blank" download>
<i class="fa fa-download"></i>
</a>
</div>
<div style="  margin-top:15px;" id="indexValue"></div>
</div>
</div>
<!--SHINY.SINGLETON[3891ac171834ed25f436995ba40a47edd74e5169]-->
<!--/SHINY.SINGLETON[3891ac171834ed25f436995ba40a47edd74e5169]-->
<!--SHINY.SINGLETON[45534f2c59c7069db5da7f5118dc12c792e86de5]-->
<!--/SHINY.SINGLETON[45534f2c59c7069db5da7f5118dc12c792e86de5]-->
<div class="shiny-spinner-output-container  ">
<div class="load-container shiny-spinner-hidden load1">
<div id="spinner-45fc87ae2582f513f1ff1b9223156d58" class="loader">Loading...</div>
</div>
<div id="indexPlot" class="shiny-image-output" style="width: 604px ; height: 409px" data-hover-id="plotIndex_hover" data-hover-delay="300" data-hover-delay-type="debounce" data-hover-clip="TRUE" data-hover-null-outside="TRUE"></div>
</div>
</div>
<div class="tab-pane" data-value="classificazione.panel" id="tab-1819-4">
<div class="row">
<div class="col-sm-5">
<div class="form-group shiny-input-container">
<label class="control-label" for="myTrainingClasses">Aggiungi/scegli classe POI</label>
<div>
<select id="myTrainingClasses" class="form-control"><option value="" selected></option></select>
<script type="application/json" data-for="myTrainingClasses">{"create":true}</script>
</div>
</div>
<div style="display:flex;gap:5px;">
<div title="Disegna i POI sulla mappa a sinistra">
<button class="action-button bttn bttn-fill bttn-sm bttn-default bttn-no-outline" id="plotTrain" type="button">
<i class="fa fa-pen"></i>
Disegna
</button>
</div>
<div title="Elimina le righe selezionate">
<button class="action-button bttn bttn-fill bttn-sm bttn-default bttn-no-outline" id="delTrain" type="button">
<i class="fa fa-remove"></i>
Elimina
</button>
</div>
<div title="Rimuovi tutti i POI">
<button class="action-button bttn bttn-fill bttn-sm bttn-default bttn-no-outline" id="resetTrain" type="button">
<i class="fa fa-trash"></i>
RESET
</button>
</div>
</div>
</div>
<div class="col-sm-7">
<div>
<div id="trainingTable" style="width:100%; height:auto; " class="datatables html-widget html-widget-output"></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p><strong>Esercizio 1:</strong> Seleziona due combinazione di bande da assegnare ai canali dello schermo tali da: 1. visualizzare a colori reali l’immagine. 2. visualizzare il NIR - near infrared 3. un’altra combinazione a scelta</p>
<p><strong>Esercizio 2:</strong> raccogliete 4 firme spettrali, di elementi diversi, e.g. il canale, urbanizzato, vegetazione e la zona industriale.</p>
</div>
<div id="section-classificazione-supervisionata" class="section level2">
<h2>Classificazione “supervisionata”</h2>
<p>We will use only the SWIR because it is a lighter image and takes less time to process in real time and we do not want to be bored waiting for image to classify.</p>
<ol style="list-style-type: decimal">
<li>Grab some training pixels by choosing the class and start clicking on the image below.</li>
<li>Click <strong>PLOT</strong> if you want to redraw the points that were clicked (image is NOT auto-updated)</li>
<li>Once finished <strong>clic “RUN”</strong> to start training/validation/testing phase of the following models:</li>
<li>You will see a plot of signatures AND classified images</li>
</ol>

<script type="application/shiny-prerendered" data-context="server-start">
knitr::opts_chunk$set(echo = FALSE, message=FALSE )
library(tidyverse)
</script>
 
<script type="application/shiny-prerendered" data-context="server">
#shinyjs::useShinyjs(html = TRUE)
</script>
 
<script type="application/shiny-prerendered" data-context="server">
 tags$style(HTML('table.dataTable.hover tbody tr:hover, table.dataTable.display tbody tr:hover {background-color: pink !important; cursor:pointer;}'))


observeEvent(input$POItableRowHover, {  
  req(input$POItableRowHover, !is.na(as.integer(input$POItableRowHover[[1]])))
  isolate({
      dd<-react$train.table[as.integer(input$POItableRowHover[[1]]), ]
      runjs( sprintf("enterImg(null); putLens(%d, %d)  ", dd$X, dd$Y  ) )
  })
})


observeEvent(input$cookie.username, { 
  #runjs( sprintf( "alert('%s')",input$cookie.username ) )
  req(input$cookie.username)
  ls<-readRDS("log.rds")
  if(!is.null(ls[[ input$cookie.username ]] ) ) {
    ls[[ input$cookie.username ]] <- list("lastlog"=Sys.Date(), "nlogs"=ls[[ input$cookie.username ]][[ "nlogs" ]]+1 )
  } else {
    ls[[ input$cookie.username ]]<-list("lastlog"=Sys.Date(), "nlogs"=0)
  }

  saveRDS(ls,"log.rds")
  
  img.file.sigs<<-img.file
  raster::extension(img.file.sigs)<<-sprintf("%s.rds", fs::path_sanitize(input$cookie.username, "_") )
  
  if (file.exists(img.file.sigs)) {
     tt<-  readRDS(img.file.sigs)
     react$train.table<-tt
     return(NULL)
  }
  
 # img.file.sigs<<-NULL
  img.file.sigs2<-img.file
  raster::extension(img.file.sigs2)<-"rds"
  
  if (file.exists(img.file.sigs2)) {
     tt<-  readRDS(img.file.sigs2)
     saveRDS(tt, img.file.sigs)
     react$train.table<-tt
  }

})

### zoom LENTI
shiny::observeEvent(input$zoomLens, {
  req(input$zoomLens)
  shinyjs::runjs(
    sprintf(
      "lenszoom=%s; if($('#myImageDOMplot img').length==1) imageZoom( $('#myImageDOMplot img').get(0), \"myresult\", false );  ",
      input$zoomLens,
      input$zoomLens
    )
  )
}, ignoreInit = T)

#### INDEX DOWNLOAD ------
output$indexDownload <- downloadHandler(
    
    filename = function() {
      paste(tempfile(), ".tif", sep = "")
    },
    content = function(file) {

      if( is.element("error", class(myImage)) ){
        runjs(sprintf("alert(\"%s\");", translations$index.fomula.wrong[[lang]] ) )
        return(NULL)
      }
      ##write.csv(iris, file, row.names = FALSE)
    
      raster::writeRaster(out.raster, file, format="GTiff")
    }
  )

  output$indexPlot <-
    renderPlot({ })


#### CALCOLA INDICE ###############
shiny::observeEvent(input$indexGo, {
  req(input$indexIn, input$indexGo)
  eq <- gsub("B([1-9A]{1,2})", "myImage[['B\\1']]", input$indexIn)
  
  out.raster <<- tryCatch( eval(parse(text = eq)), 
                        error = function(e) { e })  

  if( is.element("error", class(out.raster)) ){
    runjs(sprintf("alert(\"%s\");", translations$index.fomula.wrong[[lang]] ) )
    return(NULL)
  }
   
   
  
  output$indexPlot <-
    renderPlot({
      
    par(ann = FALSE,
        bg = "black",
        bty = "n",
        mai = c(0,0,0,0),
        mgp = c(0, 0, 0),
        oma = c(0,0,0,0),
        omd = c(0,1,0,1),
        omi = c(0,0,0,0),
        mar = c(0,0,0,0), 
        plt = c(0,1,0,1), 
        xpd = FALSE, 
        yaxt = 'n')
      
      image(
        out.raster,
#        par.settings = RdBuTheme,
        box=FALSE,
       # border=NA,
        ann=FALSE,
        axes = FALSE#,
      #  legend=T
      )
    })
  
} )

shiny::observeEvent(input$indexChoose, {
  req(input$indexChoose)
  updateTextInput(session = session,
                  inputId = "indexIn",
                  value = input$indexChoose)
}, ignoreInit = T)

shiny::observeEvent(input$colorChoose, {
  bands <- strsplit(input$colorChoose, ",")[[1]]
  bb <- c("bandR", "bandG", "bandB")
  names(bb) <- bands
  isolate({
    for (i in bands) {
      updatePickerInput(
        session = session,
        inputId =  trimws(bb[[i]]),
        selected = trimws(i)
      )
    }
  })
}, ignoreInit = T)

output$myImageDOMplot <- renderPlot({
  req(input$bandR, input$bandG, input$bandB)
  
  plotRGB(
    myImage,
    r = isolate({
      which(input$bandR == bands.alias)
    }),
    g = isolate({
      which(input$bandG == bands.alias)
    }),
    b = isolate({
      which(input$bandB == bands.alias)
    }),
    stretch = "hist",
    main = "Clicca per firma spettrale pixel - doppio click per aggiungere"
  )
  
})

output$coordinate<-renderText({
    
    xy_str <- function(e) {
      if(is.null(e)) return("NULL\n")
      paste0("E=", as.integer(e$x ), " N=", as.integer(e$y ) )
    }  
    
    xy_str(input$plot_hover)
    
  })

observeEvent(input$plotIndex_hover, {
  req(out.raster, input$plotIndex_hover$x)
  vv<-raster::cellFromXY(
      myImage ,
      c(input$plotIndex_hover$x, input$plotIndex_hover$y)
    )
  va<-"?"
  if(is.numeric(vv)){
      va<-round( out.raster[vv], 3) 
  }

  
  runjs(sprintf( "$('#indexValue').html('<b>Index value at mouse<\u002fb><br>%s')", va  ) )

})

observeEvent(input$pannelli, {
 
 if(loaded) runjs( sprintf("   $(\"#finestraGV\").css({ 'visibility':'%s' }); ",
              ifelse(input$pannelli=="GV.panel", "visible","hidden") ) )
  
 if(!loaded) loaded<<-T
 
}, ignoreInit = T  )

observeEvent( input$plot_click  , {
  
  
 if( input$pannelli=="GV.panel" ){ 
  
   if(!isTruthy(input$plot_click)){
     output$graphGVtiles <- renderPlotly({  })
     return(NULL)
   }
     
   size<- input$dimGV
   offset <- ((size-1)/2)
   
   col1<-raster::colFromX(myImage, input$plot_click$x) - offset
   row1<-raster::rowFromY(myImage, input$plot_click$y) - offset
   
   runjs( sprintf("  $(\"#finestraGV\").css({ 'visibility':'visible', 'top':'%spx', 'left':'%spx', 'width':'%spx', 'height':'%spx'  }); ",  row1-2, col1-2, size+4, size+4 ) )
   
   
   if(col1 < 0){ col1 <- 0 }
   if(row1 < 0){ row1 <- 0 }
   
   if(col1 > (ncol(myImage)-1) ){ col1 <- ncol(myImage)-1-size }
   if(row1 > (nrow(myImage)-1) ){ row1 <- nrow(myImage)-1-size }
   
  
   output$graphGVtiles <- renderPlotly({
     
      
   rast <- as.data.frame( 
              getValuesBlock(myImage, 
                  row=row1, nrows=size, 
                  col=col1, ncols=size, format="m")
            )
   
   rast <- rast / 10000
   b <- lapply(rast, function(x){ matrix(x, nrow=size, ncol=size, byrow=TRUE) })
   
   rast.m<-reshape2::melt(b)
   names(rast.m)<-c("x","y", "Rifl","Band")
   rast.m$Band<- factor(rast.m$Band, levels=bands.alias )
   
   
     ggplot(rast.m, aes(x=y,y=size-x))  + 
      geom_raster(aes(fill=Rifl)) +
      facet_wrap(vars(Band), ncol = 3) +
      theme_bw() +
       coord_fixed(expand=F) +
      scale_fill_distiller(palette = "Greys")
      })
   
 }
  
 if( input$pannelli=="firme.panel" ){ 
   
    values <- gdalUtils::gdallocationinfo(img.file, input$plot_click$x,
                              input$plot_click$y, geoloc=T, valonly = T)
    
    values.num <- as.numeric(values) 
    
    x.click <- as.integer(input$plot_click$x)
    y.click <- as.integer(input$plot_click$y)
    
    plotlyProxyInvoke(plotlyProxy("graph1", session), "addTraces", list(
    list(
    x = as.integer(bands.wavelengths.nm),
    name = sprintf("(%d, %d)", x.click, y.click),
    y = values.num / 10000,
    type = 'scatter',
    mode = 'markers+lines',  line = list(shape = "spline")
    )
    
    ))
  
  }
  

 if( input$pannelli=="classificazione.panel" ){
   
   Class<-isolate(input$myTrainingClasses)

   if(!isTruthy(Class)){
     shinyjs::alert("Devi selezionare una classe dalla lista o crearne una!")
        currClass<<-NULL
     return(NULL)
   }
   
  currClass<<-Class  
  col1<-raster::colFromX(myImage, input$plot_click$x) 
  row1<-raster::rowFromY(myImage, input$plot_click$y)
   
  dt<-isolate(react$train.table)
  row<-list( 
        East =  input$plot_click$x ,
        North =  input$plot_click$y,
        X = col1 ,
        Y = row1 ,
        Class = Class
      )
   
  dt.final<- rbind( react$train.table, row  )
  react$train.table<-dt.final
 
  if(!is.null(img.file.sigs) ) saveRDS(dt.final, img.file.sigs)
  
  }
  
}, ignoreInit = T )

output$graph1 <- renderPlotly({
 
  input$resetGraph
 

   plot_ly(type = "scatter", mode = "markers") %>% layout(
     hoverlabel= list(align="left"),
    margin = list(l = 5, r = 2, b = 20, t = 30),
    showlegend = T, legend = list(orientation = 'h'),
    xaxis = list(title = "Lunghezza d'Onda (nm)", y=0  ),
    yaxis = list(title = "Riflettanza Bottom-Of-Atmosphere (BOA)"),
    title = sprintf("Firme spettrali"),
    shapes = rectangles
    
  )  %>%  add_markers(
       x = s2.bands$mid.wl,
       y = 0,
       name = "Info Bande",
       hovertemplate = paste(
         sep = "",
         '<b>Lunghezza d\'onda centrale<\u002fb>: %{x} nm<br>',
         '%{text}'
       ),
       text = sprintf(
         "<b>Larghezza banda nello spettro:<\u002fb> %s nm<br><b>Nome banda:<\u002fb><font>%s<\u002ffont><br><b>Risoluzione spaziale pixel:<\u002fb> %s m<br><b>Descrizione:<\u002fb><br>%s",
         s2.bands$size.wl,
         s2.bands$name,
         s2.bands$size.pixel,
         lapply(s2.bands$desc.ita, function(x) {
           paste0(collapse = "<br>", stringi::stri_wrap(x, 30, 0.0))
         })
       ),
       
       marker = list(
         symbol = "square",
         color = "black",
         size = 9
       )
     ) 
})


observeEvent(input$plotTrain, {
  req(input$plotTrain)
  isolate({
    if (shiny::isTruthy(react$train.table) && nrow(react$train.table)) {
      col <- RColorBrewer::brewer.pal(9, "Paired")
      col2 <- RColorBrewer::brewer.pal(9, "Pastel1")
      train.table.classes <- as.factor(react$train.table$Class)

      runjs( sprintf("draw( %s,  %s,  %s,  %s)", 
                     jsonlite::toJSON(colFromX(myImage, react$train.table$East) ),
                     jsonlite::toJSON(rowFromY(myImage, react$train.table$North) ),
                     jsonlite::toJSON( rownames(react$train.table)  ),
                     jsonlite::toJSON(col2[train.table.classes]) ) );
      # points(
      #   react$train.table$x,
      #   react$train.table$y,
      #   col = col[train.table.classes],
      #   bg = col2[train.table.classes],
      #   pch = 21
      # )
      # 
      # text(
      #   react$train.table$x,
      #   react$train.table$y,
      #   pos = 2,
      #   react$train.table$id,
      #   col = col[train.table.classes]
      # )

    }
  })

})

output$trainingTable <- DT::renderDT({
 
  req(react$train.table, input$pannelli)
  if(input$pannelli!="classificazione.panel"){
    runjs("$(\".myCanvasTrain\").remove();")
    return(NULL)
  }
  
  
  shiny::updateSelectizeInput(session = session, inputId =  "myTrainingClasses", choices = c("", unique(react$train.table$Class) ), selected=currClass ) 
  
  callback <- c( 
  "table.on('mouseenter', 'tr', function(){", 
  " var index = table.row(this);", 
  " if(index!==undefined) {  Shiny.setInputValue('POItableRowHover', index[0], {priority: 'event'}); }",
  "});"
  )
  
  col <- RColorBrewer::brewer.pal(9, "Paired")
  col2 <- RColorBrewer::brewer.pal(9, "Pastel1")
  train.table.classes <- as.factor(react$train.table$Class)

  runjs( sprintf("draw( %s,  %s,  %s,  %s)", 
                     jsonlite::toJSON(colFromX(myImage, react$train.table$East) ),
                     jsonlite::toJSON(rowFromY(myImage, react$train.table$North) ),
                 jsonlite::toJSON( rownames(react$train.table)  ),
                 jsonlite::toJSON(col2[train.table.classes])
                 ) );
  
  datatable(
    react$train.table[ order( as.integer(rownames(react$train.table)), decreasing = T ), ],
    rownames = T,
      callback = JS(callback),
    #callback = JS(callback),
    extensions = 'Scroller',
    options = list( 
      class = "display nowrap compact",
      pageLength = 1000, 
      scrollY = 250,
      scroller = TRUE, 
      dom = 'ft'
    )
  ) %>% formatRound(c(1:2), 2)
  
})

observeEvent(input$delTrain,  {
  
  req(input$trainingTable_rows_selected)
  
  isolate({
    react$train.table <-
     react$train.table[ -input$trainingTable_rows_selected, ]
  })
})


observeEvent(input$resetTrain,  {
  isolate({
    react$train.table <-
     data.frame(
      East = numeric(0) ,
      North = numeric(0),
      X = integer(0) ,
      Y = integer(0),
      Class = character(0)
    )
  })
})

observeEvent(input$runTrain, {
  
  req(input$runTrain, react$train.table)
  
 # saveRDS(react$train.table, "s2.train.table.rds")
  
  if (nrow(react$train.table) < 10) {
    shinyWidgets::alert("Almeno 10 punti di ROI per classe", status =
                          "warning")
    shinyjs::alert("Almeno 10 punti di ROI per classe")
    return(NULL)
  }
  
  
  if (sum(table(react$train.table$Class) < 10) != 0) {
    whi <-
      paste0(collapse = ", ", names(which( table(
        react$train.table$Class
      ) < 10)))
    shinyWidgets::alert(
      sprintf(
        "Almeno 10 punti di ROI per classe.",
        whi
      ),
      status = "warning"
    )
    shinyjs::alert(sprintf(
      "Almeno 10 punti di ROI per classe! Classe/i %s hanno pochi punti ROI.",
      whi
    ))
    return(NULL)
  }
  
  ss <-
    matrix(
      data = NA,
      nrow = nrow(react$train.table),
      ncol = length( bands.wavelengths.nm)
    )
  
  withProgress(
    message = "Leggo le firme spettrali", 
    value = 0,
    min = 0,
    max = nrow(react$train.table),
    {
      for (i in 1:nrow(react$train.table)) {
        setProgress(as.integer(i), detail=sprintf("Punto %s", i))
        ss[i,] <-
          as.numeric(
            gdalUtils::gdallocationinfo(
              img.file, geoloc=T, 
              react$train.table[i, "X"]  ,
              react$train.table[i, "Y"],
              valonly = T
            )
          )
      }
    }
  )
  
  if (is.null(ss)) {
    shinyjs::alert("ISNULL!")
    return(NULL)
  }
  
  train.data <-
    as.data.frame(cbind(react$train.table[c("Class")], ss))
  
  ###############################################################################
  ### from here  is only for plotting - our training data is  "train.data"
  quants <- c(0.1, 0.25, 0.5, 0.75, 0.9)
  df.with.ss2 <-
    train.data  %>%  dplyr::group_by(Class) %>% dplyr::summarize_all(function(x) {
      if (is.numeric(x))
        quantile(as.numeric(x), quants)
      else
        c(0, 0, 0, 0, 0)
    })
  
  df.with.ss2$Quantile <-
    rep(sprintf("Q%s", quants * 100), length(unique(df.with.ss2$Class)))
  #saveRDS(as.data.frame(df.with.ss2), "df.with.ss2.rds")
  
  df.with.ss3 <- reshape2::melt(df.with.ss2)
  df.with.ss4 <-
    reshape2::dcast(df.with.ss3 ,   Class + variable ~ Quantile)
  df.with.ss4$Wavelength <-
    bands.wavelengths.nm[df.with.ss4$variable]
  df.with.ss4[df.with.ss4 == 0] <- NA
  
  output$plot3 <- renderPlot({
    p <-
      ggplot(df.with.ss4,
             aes(
               x = Wavelength,
               y = Q50,
               group = Class,
               fill = Class,
               color = Class
             )) +
      geom_point() +
      geom_ribbon(aes(ymin = Q25,  ymax = Q75),
                  alpha = .3,
                  linetype = 0) +
      xlab("Wavelength (nm)") +
      ylab("Radiance at sensor") +
      ggtitle("Trainer signatures - Q50 and IQR") +
      theme_bw()
    print(p)
  })
  
  
  ###############################################################################
  ### from here  is AI -- our training data is  "train.data"
  ## losely from https://github.com/zia207/Satellite-Images-Classification-with-H2O-R
  train.data$Class <- as.factor(train.data$Class)
  
  ### to make things faster I  select only 40 spectral bands... 288 are too many, getting close to overfitting - BUT
  ### I use to most important ones... which are they?
  # cols<-sample(1:length(bands.wavelengths.nm), 50)
  #  train.data2<-train.data[, c("Class", as.character(cols))]
  
  names(train.data) <- c("Class", names(myImage))
  localH2o <- h2o.init(nthreads = -1, max_mem_size = "50G")
  #### Import data to H2O cluster
  train <-  as.h2o(train.data)
  myImage.df<-NULL
  withProgress(message = "Elaborazione con Algoritmi di Intelligenza Artificiale",
               detail = "Converto immagine a matrice n2D...",
               value = 0,
               {
                 myImage.df<-as.data.frame(myImage)
                 
                 setProgress(value = 0.1 ,
                             detail = "Converto matrice a oggetto h2o...")
                 
                 grid <-  as.h2o(myImage.df)
                 #grid<- as.h2o(grid.data)
                 
                 #### Split data into train, validation and test dataset
                 # splits <- h2o.splitFrame(df, c(0.75,0.125), seed=1234)
                 # train  <- h2o.assign(splits[[1]], "train.hex") # 75%
                 # valid  <- h2o.assign(splits[[2]], "valid.hex") # 12%
                 # test   <- h2o.assign(splits[[3]], "test.hex")  # 13%
                 
                 
                 
                 y <- "Class"
                 x <- setdiff(names(train.data), y)
                 models <- list()
                 setProgress(value = 0.21 ,
                             detail = sprintf("Creo modello di classificazione con metodo '%s'.", model.names[["RF"]]))

                 models[["RF"]] <- h2o.randomForest(
                   x = x,
                   y = y,
                   ntrees = 10,
                   max_depth = 5,
                   min_rows = 10,
                   binomial_double_trees = TRUE,
                   training_frame = train
                 )

                 setProgress(value = 0.24 ,
                             detail = sprintf("Creo modello di classificazione con metodo '%s'.", model.names[["NB"]]))
                 models[["NB"]]  <- h2o.naiveBayes(
                   x = x,
                   y = y,
                   training_frame = train,
                   laplace = 0,
                   nfolds = 3,
                   seed = 1234
                 )

                 setProgress(value = 0.26 ,
                             detail = sprintf("Creo modello di classificazione con metodo '%s'.", model.names[["GMB"]]))
                 models[["GMB"]]  <- h2o.gbm(
                   x = x,
                   y = y,
                   training_frame = train,
                   ntrees = 10,
                   max_depth = 3,
                   min_rows = 2,
                   learn_rate = 0.2,
                   nfolds = 3,
                   keep_cross_validation_predictions = TRUE,
                   seed = 1
                 )
                 ## Deep Learning Model
                 setProgress(value = 0.28 ,
                             detail = sprintf("Creo modello di classificazione con metodo '%s'.", model.names[["DL"]]))
                 models[["DL"]]  <- h2o.deeplearning(
                   model_id = "Deep_Learning",
                   # Destination id for this model
                   training_frame = train,
                   # Id of the training data frame
                   #  validation_frame=valid,                    # Id of the validation data frame
                   x = x,
                   # a vector predictor variable
                   y = y,
                   # name of reponse vaiables
                   standardize = TRUE,
                   # standardize the data
                   score_training_samples = 0,
                   # training set samples for scoring (0 for all)
                   activation = "RectifierWithDropout",
                   # Activation function
                   score_each_iteration = TRUE,
                   hidden = c(200, 200, 200, 200),
                   # 4 hidden layers, each of 200 neurons
                   hidden_dropout_ratios = c(0.2, 0.1, 0.1, 0),
                   # for improve generalization
                   stopping_tolerance = 0.001,
                   # tolerance for metric-based stopping criterion
                   epochs = 100,
                   # the dataset should be iterated (streamed)
                   adaptive_rate = TRUE,
                   # manually tuned learning rate
                   l1 = 1e-6,
                   # L1/L2 regularization, improve generalization
                   l2 = 1e-6,
                   max_w2 = 10,
                   # helps stability for Rectifier
                   nfolds = 3,
                   # Number of folds for K-fold cross-validation
                   fold_assignment = "Stratified",
                   # Cross-validation fold assignment scheme
                   keep_cross_validation_fold_assignment = TRUE,
                   seed = 125,
                   reproducible = TRUE,
                   variable_importances = T
                 )

                 
                 rasters <- list()
                 for (i in names(models)) {
                   setProgress(
                     value = 0.3 + length(rasters) / 100 ,
                     detail = sprintf("Applico classificazione con modello %s", model.names[[i]])
                   )
                   g.predict = as.data.frame(h2o.predict(object = models[[i]], newdata = grid))
                   rasters[[i]] <-  raster(myImage)
                   rasters[[i]][]  <-
                     factor(g.predict$predict, levels = levels(train.data$Class))
                 }
                 
                 setProgress(value = 0.4, detail = "Creo grafico...")
                 rb <- raster::brick(rasters)
                 
                 
  
  
                models.rminer<-list()
                rasters.rminer<-list()
                  
  
                # setProgress(value = 0.42, message = "Utilizzo libreria RMINER...", detail=".....")
  
         
                 setProgress(value = 0.48 ,
                             detail = sprintf("Creo modello di classificazione con metodo %s.", model.names[[ "SVM" ]] ) )
 
                models.rminer[["SVM"]] <- rminer::fit(Class~.,data=train.data, task="class",  model="ksvm", feature="s") 
                
     
                setProgress(value = 0.5 ,
                             detail = sprintf("Applico classificazione con metodo '%s'.", model.names[[ "SVM" ]] ))
                         
             
    
                 rasters.rminer[[ model.names[[ "SVM" ]]  ]] <- predict(myImage,  models.rminer[["SVM"]] )
 
                 
                models.rminer[["RF"]] <- rminer::fit(Class~.,data=train.data, task="class",  model="randomForest") 
                
                
                 print("6")
 setProgress(value = 0.6 ,
                             detail = sprintf("Applico classificazione con metodo '%s'.", model.names[[ "RF" ]] ))
                rasters.rminer[[ model.names[[ "RF" ]]  ]] <-  raster::predict(myImage,  models.rminer[["RF"]] )
                
                
                 print("7")
                models.rminer[["KNN"]] <- rminer::fit(Class~.,data=train.data, task="class",  model="knn") 
                                
 setProgress(value = 0.7 ,
                             detail = sprintf("Applico classificazione con metodo '%s'.", model.names[[ "KNN" ]] ))
                rasters.rminer[[ model.names[[ "KNN" ]]    ]] <- raster::predict(  myImage, models.rminer[["KNN"]] )


                 print("8")
                 setProgress(value = 0.89, detail = "Creo grafico...")
                 

                 
               })
  
                 print("9")
                    rb.rminer <- raster::brick(rasters.rminer)
                  output$plot5 <- renderPlot({  levelplot(rb.rminer,  xlab = "X", ylab = "Y", main="Modelli da libreria rminer")  })
  
                 print("99")
                    lu <- levelplot(rb,  xlab = "X", ylab = "Y")
                  
                  output$plot4 <- renderPlot({  lu  })
                  
                 
})



</script>
 <!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.11.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.3"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bootstrap"]},{"type":"character","attributes":{},"value":["3.3.5"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/bootstrap"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["viewport"]}},"value":[{"type":"character","attributes":{},"value":["width=device-width, initial-scale=1"]}]},{"type":"character","attributes":{},"value":["js/bootstrap.min.js","shim/html5shiv.min.js","shim/respond.min.js"]},{"type":"character","attributes":{},"value":["css/bootstrap.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.3"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.11.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.3"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["navigation"]},{"type":"character","attributes":{},"value":["1.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/navigation-1.1"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["tabsets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.3"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["accessible-code-block"]},{"type":"character","attributes":{},"value":["0.0.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["rmd/h/accessibility"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["empty-anchor.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["rmarkdown"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["2.3"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["shinyWidgets"]},{"type":"character","attributes":{},"value":["0.5.3"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href","file"]}},"value":[{"type":"character","attributes":{},"value":["shinyWidgets"]},{"type":"character","attributes":{},"value":["assets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinyWidgets-bindings.min.js"]},{"type":"character","attributes":{},"value":["shinyWidgets.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinyWidgets"]},{"type":"logical","attributes":{},"value":[false]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectPicker"]},{"type":"character","attributes":{},"value":["1.13.12"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href","file"]}},"value":[{"type":"character","attributes":{},"value":["shinyWidgets/selectPicker"]},{"type":"character","attributes":{},"value":["assets/selectPicker"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/bootstrap-select.min.js"]},{"type":"character","attributes":{},"value":["css/bootstrap-select.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinyWidgets"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["ionrangeslider"]},{"type":"character","attributes":{},"value":["2.1.6"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href"]}},"value":[{"type":"character","attributes":{},"value":["shared/ionrangeslider"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/ion.rangeSlider.min.js"]},{"type":"character","attributes":{},"value":["css/ion.rangeSlider.css","css/ion.rangeSlider.skinShiny.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["strftime"]},{"type":"character","attributes":{},"value":["0.9.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href"]}},"value":[{"type":"character","attributes":{},"value":["shared/strftime"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["strftime-min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"character","attributes":{},"value":["1.5.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmlwidgets"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.5.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["plotly-binding"]},{"type":"character","attributes":{},"value":["4.9.2.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["plotly.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["plotly"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["4.9.2.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["font-awesome"]},{"type":"character","attributes":{},"value":["5.13.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/fontawesome"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/all.min.css","css/v4-shims.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["bttn"]},{"type":"character","attributes":{},"value":["0.2.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href","file"]}},"value":[{"type":"character","attributes":{},"value":["shinyWidgets/bttn"]},{"type":"character","attributes":{},"value":["bttn"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["bttn.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shinyWidgets"]},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.11.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["href"]}},"value":[{"type":"character","attributes":{},"value":["shared/selectize"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"character","attributes":{},"value":["<!--[if lt IE 9]>\n<script src=\"shared/selectize/js/es5-shim.min.js\"><\/script>\n<![endif]-->\n<script src=\"shared/selectize/js/selectize.min.js\"><\/script>"]},{"type":"NULL"},{"type":"NULL"},{"type":"logical","attributes":{},"value":[true]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["jquery"]},{"type":"character","attributes":{},"value":["1.12.4"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/lib/jquery"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["jquery.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.15"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-css"]},{"type":"character","attributes":{},"value":["0.0.0"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets/css"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables-crosstalk.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.15"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["datatables-binding"]},{"type":"character","attributes":{},"value":["0.15"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["htmlwidgets"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["datatables.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["DT"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["0.15"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"character","attributes":{},"value":["1.1.0.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/crosstalk.min.js"]},{"type":"character","attributes":{},"value":["css/crosstalk.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["crosstalk"]},{"type":"logical","attributes":{},"value":[true]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116]}},"value":[{"type":"character","attributes":{},"value":["abind","assertthat","backports","base","bitops","blob","broom","car","carData","cellranger","class","cli","codetools","colorspace","compiler","crayon","crosstalk","curl","data.table","datasets","DBI","dbplyr","digest","dplyr","DT","dygraphs","e1071","ellipsis","evaluate","fansi","fastmap","forcats","foreign","fs","generics","ggplot2","glue","graphics","grDevices","grid","gtable","h2o","haven","hexbin","hms","htmltools","htmlwidgets","httpuv","httr","jpeg","jsonlite","knitr","later","lattice","latticeExtra","lazyeval","lifecycle","lubridate","magrittr","methods","mime","modelr","munsell","nnet","openxlsx","parallel","pillar","pkgconfig","plotly","plyr","png","promises","purrr","R6","randomForest","rasclass","raster","rasterVis","RColorBrewer","Rcpp","RCurl","readr","readxl","reprex","reshape2","rgdal","rio","rlang","rmarkdown","RSNNS","rstudioapi","rvest","scales","shiny","shinycssloaders","shinyjs","shinyWidgets","sp","stats","stringi","stringr","tibble","tidyr","tidyselect","tidyverse","tools","utils","vctrs","viridisLite","withr","xfun","xml2","xtable","yaml","zip","zoo"]},{"type":"character","attributes":{},"value":["1.4-5","0.2.1","1.1.8","4.0.2","1.0-6","1.2.1","0.7.0","3.0-9","3.0-4","1.1.0","7.3-17","2.0.2","0.2-16","1.4-1","4.0.2","1.3.4","1.1.0.1","4.3","1.13.0","4.0.2","1.1.0","1.4.4","0.6.25","1.0.1","0.15","1.1.1.6","1.7-3","0.3.1","0.14","0.4.1","1.0.1","0.5.0","0.8-80","1.5.0","0.0.2","3.3.2","1.4.1","4.0.2","4.0.2","4.0.2","0.3.0","3.30.1.1","2.3.1","1.28.1","0.5.3","0.5.0","1.5.1","1.5.4","1.4.2","0.1-8.1","1.7.0","1.29","1.1.0.1","0.20-41","0.6-29","0.2.2","0.2.0","1.7.9","1.5","4.0.2","0.9","0.1.8","0.5.0","7.3-14","4.1.5","4.0.2","1.4.6","2.0.3","4.9.2.1","1.8.6","0.1-7","1.1.1","0.3.4","2.4.1","4.6-14","0.2.2","3.3-13","0.48","1.1-2","1.0.5","1.98-1.2","1.3.1","1.3.1","0.3.0","1.4.4","1.5-16","0.5.16","0.4.7","2.3","0.4-12","0.11","0.3.6","1.1.1","1.5.0","1.0.0","1.1","0.5.3","1.4-2","4.0.2","1.4.6","1.4.0","3.0.3","1.1.1","1.1.0","1.3.0","4.0.2","4.0.2","0.3.2","0.3.0","2.2.0","0.16","1.3.2","1.8-4","2.2.1","2.1.0","1.8-8"]}]}]}
</script>
<!--/html_preserve-->
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("section-TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
